# $Id$
# $URL$
# $Rev$
# $Author$
# $Date$

export MONO_PATH=../lib:$$MONO_PATH

CSC=gmcs
#AOT=mono --aot -O=all
AOT=true
COPY=cp
MKDIR=mkdir

PREFIX=/usr/local
DESTDIR=
INSTALL_DIR=$(DESTDIR)$(PREFIX)/lib/smuxi
INSTALL_BIN_DIR=$(DESTDIR)$(PREFIX)/bin
INSTALL_APPLICATIONS_DIR=$(DESTDIR)$(PREFIX)/share/applications

SMARTIRC_DLL=Meebey.SmartIrc4net.dll
SMARTIRC_DIR=../lib
SMARTIRC_REF=-r:$(SMARTIRC_DIR)/$(SMARTIRC_DLL)

LOG4NET_DLL=log4net.dll
LOG4NET_DIR=../lib
LOG4NET_REF=-r:$(LOG4NET_DIR)/$(LOG4NET_DLL) 

NINI_DLL=Nini.dll
NINI_DIR=../lib
NINI_REF=-r:$(NINI_DIR)/$(NINI_DLL)

POSIX_DLL=Mono.Posix.dll
POSIX_DIR=../lib
POSIX_REF=-r:$(POSIX_DIR)/$(POSIX_DLL)

ENGINE_DEFINES=CONFIG_NINI
GNOME_DEFINES=UI_GNOME,GTK_SHARP_2,CONFIG_NINI
GTK_DEFINES=UI_GTK,GTK_SHARP_2,CONFIG_NINI

SERVER_REFS=-r:System.Runtime.Remoting
ENGINE_REFS=$(SMARTIRC_REF) $(NINI_REF) $(POSIX_REF)
FRONTEND_REFS=-r:System
TEST_REFS=-r:System.Runtime.Remoting
GTK_REFS=$(NINI_REF) $(POSIX_REF) -r:System.Runtime.Remoting
GNOME_REFS=$(NINI_REF) $(POSIX_REF) -r:System.Runtime.Remoting

GTK_PACKAGES=gtk-sharp-2.0,glade-sharp-2.0
GNOME_PACKAGES=gnome-sharp-2.0,gtk-sharp-2.0,glade-sharp-2.0

RESOURCES = \
../images/splashscreen.png \
../images/about.png \
../images/connect.png \
../images/edit.png \
../glade/preferences.glade

RESOURCES_BUILD = $(foreach res,$(RESOURCES), $(addprefix -resource:,$(res)),$(notdir $(res)))

BIN_DIR=../bin
DEBUG_DIR=$(BIN_DIR)/debug
RELEASE_DIR=$(BIN_DIR)/release

COMMON_SOURCE=Common/*.cs
COMMON_TARGET=smuxi-common.dll
COMMON_DEBUG_TARGET=$(DEBUG_DIR)/$(COMMON_TARGET)
COMMON_RELEASE_TARGET=$(RELEASE_DIR)/$(COMMON_TARGET)

ENGINE_SOURCE=Engine/*.cs Engine/*/*.cs Engine/*/*/*.cs
ENGINE_TARGET=smuxi-engine.dll
ENGINE_DEBUG_TARGET=$(DEBUG_DIR)/$(ENGINE_TARGET)
ENGINE_RELEASE_TARGET=$(RELEASE_DIR)/$(ENGINE_TARGET)

SERVER_SOURCE=Server/*.cs
SERVER_TARGET=smuxi-server.exe
SERVER_DEBUG_TARGET=$(DEBUG_DIR)/$(SERVER_TARGET)
SERVER_RELEASE_TARGET=$(RELEASE_DIR)/$(SERVER_TARGET)

FRONTEND_SOURCE=Frontend/*.cs
FRONTEND_TARGET=smuxi-frontend.dll
FRONTEND_DEBUG_TARGET=$(DEBUG_DIR)/$(FRONTEND_TARGET)
FRONTEND_RELEASE_TARGET=$(RELEASE_DIR)/$(FRONTEND_TARGET)

TEST_SOURCE=Frontend-Test/*.cs
TEST_TARGET=smuxi-test.exe
TEST_DEBUG_TARGET=$(DEBUG_DIR)/$(TEST_TARGET)
TEST_RELEASE_TARGET=$(RELEASE_DIR)/$(TEST_TARGET)

GTK_SOURCE=Frontend-GNOME/*.cs Frontend-GNOME/*/*.cs
GTK_TARGET=smuxi-frontend-gtk.exe
GTK_DEBUG_TARGET=$(DEBUG_DIR)/$(GTK_TARGET)
GTK_RELEASE_TARGET=$(RELEASE_DIR)/$(GTK_TARGET)

GNOME_SOURCE=Frontend-GNOME/*.cs Frontend-GNOME/*/*.cs
GNOME_TARGET=smuxi-frontend-gnome.exe
GNOME_DEBUG_TARGET=$(DEBUG_DIR)/$(GNOME_TARGET)
GNOME_RELEASE_TARGET=$(RELEASE_DIR)/$(GNOME_TARGET)

default: all

all: debug-all release-all

debug-all: \
	$(COMMON_DEBUG_TARGET) \
	$(ENGINE_DEBUG_TARGET) \
	$(SERVER_DEBUG_TARGET) \
	$(FRONTEND_DEBUG_TARGET) \
	$(TEST_DEBUG_TARGET) \
	$(GTK_DEBUG_TARGET) \
	$(GNOME_DEBUG_TARGET) \

release-all: \
	$(COMMON_RELEASE_TARGET) \
	$(ENGINE_RELEASE_TARGET) \
	$(SERVER_RELEASE_TARGET) \
  $(FRONTEND_RELEASE_TARGET) \
	$(GTK_RELEASE_TARGET) \
	$(GNOME_RELEASE_TARGET) \

$(COMMON_DEBUG_TARGET): $(COMMON_SOURCE)
	$(CSC) -debug -define:TRACE,LOG4NET -target:library $(LOG4NET_REF) -out:$(COMMON_DEBUG_TARGET) $^
	$(AOT) $(COMMON_DEBUG_TARGET)
	#cp $(LOG4NET_DIR)/$(LOG4NET_DLL) $(DEBUG_DIR)

$(COMMON_RELEASE_TARGET): $(COMMON_SOURCE)
	$(CSC) -target:library -out:$(COMMON_RELEASE_TARGET) $^
	$(AOT) $(COMMON_RELEASE_TARGET)
	#cp $(LOG4NET_DIR)/$(LOG4NET_DLL) $(RELEASE_DIR)


$(ENGINE_DEBUG_TARGET): $(ENGINE_SOURCE)
	$(CSC) -debug -define:$(ENGINE_DEFINES),TRACE,LOG4NET -target:library $(ENGINE_REFS) -r:$(COMMON_DEBUG_TARGET)  $(LOG4NET_REF) -out:$(ENGINE_DEBUG_TARGET) $^
	$(AOT) $(ENGINE_DEBUG_TARGET)
	#cp $(LOG4NET_DIR)/$(LOG4NET_DLL) ../bin/debug
	#cp $(SMARTIRC_DIR)/$(SMARTIRC_DLL) ../bin/debug
	#cp $(NINI_DIR)/$(NINI_DLL) ../bin/debug

$(ENGINE_RELEASE_TARGET): $(ENGINE_SOURCE)
	$(CSC) -define:$(ENGINE_DEFINES) -target:library $(ENGINE_REFS) -r:$(COMMON_RELEASE_TARGET) -out:$(ENGINE_RELEASE_TARGET) $^
	$(AOT) ../bin/release/$(ENGINE_TARGET)
	#cp $(SMARTIRC_DIR)/$(SMARTIRC_DLL) ../bin/release
	#cp $(NINI_DIR)/$(NINI_DLL) ../bin/release


$(SERVER_DEBUG_TARGET): $(SERVER_SOURCE)
	$(CSC) -debug -define:TRACE,LOG4NET -target:exe $(SERVER_REFS) -r:$(ENGINE_DEBUG_TARGET) $(LOG4NET_REF) -out:$(SERVER_DEBUG_TARGET) $^
	$(AOT) $(SERVER_DEBUG_TARGET)
	#cp $(LOG4NET_DIR)/$(LOG4NET_DLL) ../bin/debug

$(SERVER_RELEASE_TARGET): $(SERVER_SOURCE)
	$(CSC) -target:exe $(SERVER_REFS) -r:$(ENGINE_RELEASE_TARGET) -out:$(SERVER_RELEASE_TARGET) $^
	$(AOT) $(SERVER_RELEASE_TARGET)


$(FRONTEND_DEBUG_TARGET): $(FRONTEND_SOURCE)
	$(CSC) -debug -define:TRACE,LOG4NET -target:library $(FRONTEND_REFS) -r:$(ENGINE_DEBUG_TARGET) $(LOG4NET_REF) -out:$(FRONTEND_DEBUG_TARGET) $^

$(FRONTEND_RELEASE_TARGET): $(FRONTEND_SOURCE)
	$(CSC) -target:library $(FRONTEND_REFS) -r:$(ENGINE_RELEASE_TARGET) -out:$(FRONTEND_RELEASE_TARGET) $^


$(TEST_DEBUG_TARGET): $(TEST_SOURCE)
	$(CSC) -debug -define:TRACE,LOG4NET -target:exe $(TEST_REFS) -r:$(COMMON_DEBUG_TARGET) -r:$(ENGINE_DEBUG_TARGET) $(LOG4NET_REF) -out:$(TEST_DEBUG_TARGET) $^
	$(AOT) $(TEST_DEBUG_TARGET)
	#cp $(LOG4NET_DIR)/$(LOG4NET_DLL) ../bin/debug


$(GTK_DEBUG_TARGET): $(GTK_SOURCE)
	$(CSC) -debug -define:$(GTK_DEFINES),TRACE,LOG4NET -nowarn:0169 -target:exe $(GTK_REFS) -r:$(COMMON_DEBUG_TARGET),$(ENGINE_DEBUG_TARGET),$(FRONTEND_DEBUG_TARGET) $(LOG4NET_REF) -pkg:$(GTK_PACKAGES) $(RESOURCES_BUILD) -out:$(GTK_DEBUG_TARGET) $^
	$(AOT) $(GTK_DEBUG_TARGET)
	#cp $(LOG4NET_DIR)/$(LOG4NET_DLL) ../bin/debug

$(GTK_RELEASE_TARGET): $(GTK_SOURCE)
	$(CSC) -define:$(GTK_DEFINES) -nowarn:0169 -target:exe $(GTK_REFS) -r:$(COMMON_RELEASE_TARGET),$(ENGINE_RELEASE_TARGET),$(FRONTEND_RELEASE_TARGET) -pkg:$(GTK_PACKAGES) $(RESOURCES_BUILD) -out:$(GTK_RELEASE_TARGET) $^
	$(AOT) $(GTK_RELEASE_TARGET)


$(GNOME_DEBUG_TARGET): $(GTK_SOURCE)
	$(CSC) -debug -define:$(GNOME_DEFINES),TRACE,LOG4NET -nowarn:0169 -target:exe $(GNOME_REFS) -r:$(COMMON_DEBUG_TARGET),$(ENGINE_DEBUG_TARGET),$(FRONTEND_DEBUG_TARGET) $(LOG4NET_REF) -pkg:$(GNOME_PACKAGES) $(RESOURCES_BUILD) -out:$(GNOME_DEBUG_TARGET) $^
	$(AOT) $(GNOME_DEBUG_TARGET)
	#cp $(LOG4NET_DIR)/$(LOG4NET_DLL) ../bin/debug

$(GNOME_RELEASE_TARGET): $(GTK_SOURCE)
	$(CSC) -define:$(GNOME_DEFINES) -nowarn:0169 -target:exe $(GNOME_REFS) -r:$(COMMON_RELEASE_TARGET),$(ENGINE_RELEASE_TARGET),$(FRONTEND_RELEASE_TARGET) -pkg:$(GNOME_PACKAGES) $(RESOURCES_BUILD) -out:$(GNOME_RELEASE_TARGET) $^
	$(AOT) $(GNOME_RELEASE_TARGET)

install: install-debug-all

install-base:
	$(MKDIR) -p $(INSTALL_DIR)
	$(MKDIR) -p $(INSTALL_BIN_DIR)
	$(MKDIR) -p $(INSTALL_APPLICATIONS_DIR)
	$(COPY) ../smuxi-frontend-gnome $(INSTALL_BIN_DIR)
	$(COPY) ../smuxi.desktop $(INSTALL_APPLICATIONS_DIR)

install-debug-all: debug-all install-base
	$(COPY) $(COMMON_DEBUG_TARGET)*      $(INSTALL_DIR)
	$(COPY) $(ENGINE_DEBUG_TARGET)*      $(INSTALL_DIR)
	$(COPY) $(SERVER_DEBUG_TARGET)*      $(INSTALL_DIR)
	$(COPY) $(FRONTEND_DEBUG_TARGET)*    $(INSTALL_DIR)
	$(COPY) $(GTK_DEBUG_TARGET)*         $(INSTALL_DIR)
	$(COPY) $(GNOME_DEBUG_TARGET)*       $(INSTALL_DIR)

install-release-all: release-all install-base
	$(COPY) $(COMMON_RELEASE_TARGET)    $(INSTALL_DIR)
	$(COPY) $(ENGINE_RELEASE_TARGET)    $(INSTALL_DIR)
	$(COPY) $(SERVER_RELEASE_TARGET)    $(INSTALL_DIR)
	$(COPY) $(FRONTEND_RELEASE_TARGET)  $(INSTALL_DIR)
	$(COPY) $(GTK_RELEASE_TARGET)       $(INSTALL_DIR)
	$(COPY) $(GNOME_RELEASE_TARGET)     $(INSTALL_DIR)

clean:
	rm -f ../bin/debug/*.mdb
	rm -f ../bin/debug/*.exe.so
	rm -f ../bin/debug/*.dll.so
	rm -f $(COMMON_DEBUG_TARGET)
	rm -f $(ENGINE_DEBUG_TARGET)
	rm -f $(SERVER_DEBUG_TARGET)
	rm -f $(FRONTEND_DEBUG_TARGET)
	rm -f $(TEST_DEBUG_TARGET)
	rm -f $(GTK_DEBUG_TARGET)
	rm -f $(GNOME_DEBUG_TARGET)
	rm -f ../bin/release/*.mdb
	rm -f ../bin/release/*.exe.so
	rm -f ../bin/release/*.dll.so
	rm -f $(COMMON_RELEASE_TARGET)
	rm -f $(ENGINE_RELEASE_TARGET)
	rm -f $(SERVER_RELEASE_TARGET)
	rm -f $(FRONTEND_RELEASE_TARGET)
	rm -f $(TEST_RELEASE_TARGET)
	rm -f $(GTK_RELEASE_TARGET)
	rm -f $(GNOME_RELEASE_TARGET)

.PHONY: default all debug-all release-all install install-debug-all install-release-all clean
